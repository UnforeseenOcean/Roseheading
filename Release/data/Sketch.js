var canvas,ctx,width,height,interval,frameRate=1E3,frameCount=0,mouseX=0,mouseY=0,fullscreen=!1,stats,showStats=!1;window.addEventListener("load",loadEvent);function loadEvent(){canvas=document.getElementById("Sketch");canvas.addEventListener("mousemove",mouseMoveEvent);canvas.addEventListener("click",mouseClickEvent);setupFullscreen();ctx=canvas.getContext("2d");width=canvas.width;height=canvas.height;setup();showStats&&setupStats();interval=setInterval(loop,1E3/frameRate)}
function setupFullscreen(){var a=document.getElementById("fullscreen-button");a&&a.addEventListener("click",function(){canvas.requestFullscreen?canvas.requestFullscreen():canvas.mozRequestFullScreen?canvas.mozRequestFullScreen():canvas.webkitRequestFullScreen&&canvas.webkitRequestFullScreen()},!1);document.addEventListener("fullscreenchange",function(){fullscreenChangeEvent(document.fullscreen)},!1);document.addEventListener("mozfullscreenchange",function(){fullscreenChangeEvent(document.mozFullScreen)},
!1);document.addEventListener("webkitfullscreenchange",function(){fullscreenChangeEvent(document.webkitIsFullScreen)},!1)}function fullscreenChangeEvent(a){this.fullscreen=a;"undefined"!=typeof fullscreenChange&&fullscreenChange()}function findOffset(a){var b=curY=0;if(a.offsetParent){do b+=a.offsetLeft,curY+=a.offsetTop;while(a=a.offsetParent);return{x:b,y:curY}}}
function mouseMoveEvent(a){var b=findOffset(canvas);mouseX=a.pageX-b.x;mouseY=a.pageY-b.y;"undefined"!=typeof mouseMoved&&mouseMoved()}function mouseClickEvent(){"undefined"!=typeof mousePressed&&mousePressed()}function loop(){showStats&&stats.begin();draw();showStats&&stats.end();frameCount++}
function setupStats(){stats=new Stats;stats.setMode(0);stats.domElement.style.position="absolute";stats.domElement.style.top=".5em";stats.domElement.style.left=".5em";document.body.appendChild(stats.domElement)}function millis(){return Date.now()}function smoothStep(a){return 3*a*a-2*a*a*a}function constrain(a,b,c){return a<b?b:a>c?c:a}function print(a){console.log(a)}function dist(a,b,c,m){dx=c-a;dy=m-b;return Math.sqrt(dx*dx+dy*dy)}
function random(a,b){return"undefined"===typeof a?Math.random():"undefined"===typeof b?Math.random()*a:Math.random()*(b-a)+a}function pow(a,b){return Math.pow(a,b)}function floor(a){return a|0}function lerp(a,b,c){return a+(b-a)*c}function abs(a){return 0>a?-a:a}function pick(a){if("undefined"===typeof a)return 0.5<Math.random();var b=random(a)|0;return b<a?b:a}function rgb(a){return"rgb("+a+","+a+","+a+")"}
function fill(a,b){"undefined"===typeof b&&(b=this.ctx);b.strokeStyle=b.fillStyle=rgb(a|0)}function triangle(a,b,c,m,q,o,f){"undefined"===typeof f&&(f=this.ctx);f.beginPath();f.moveTo(a|0,b|0);f.lineTo(c|0,m|0);f.lineTo(q|0,o|0);f.fill();f.stroke();f.closePath()}function loadImages(a){var b=[];for(i in a){var c=new Image;c.src=a[i];b.push(c)}return b}function createCanvas(a,b){var c=document.createElement("canvas");c.width=a;c.height=b;return c}
function imageToRaw(a){a=imageToCanvas(a);return getImageData(a).data}function imageToCanvas(a,b,c){"undefined"===typeof b&&(b=a.width);"undefined"===typeof c&&(c=a.height);buffer=createCanvas(b,c);buffer.getContext("2d").drawImage(a,0,0,b,c);return buffer}function getImageData(a){return getContext(a).getImageData(0,0,a.width,a.height)}function getContext(a){return a.getContext("2d")}
function background(a,b){"undefined"===typeof b&&(b=this.ctx);b.save();b.fillStyle=rgb(a);b.fillRect(0,0,width,height);b.restore()};var base,target,baseSmall,targetSmall,screenImageData,baseImageData,altImageData,altStates,positions,states,pw,ph,pn,pieceSize=10,moveRadius=16,moveTime=2E3,piecePositions,backwards=!1,lastBackwards=!1,backwardsStart=0,idleTime=4E3,lastMouseMoved=millis();
function setupMosaic(){pw=floor(width/pieceSize);ph=floor(height/pieceSize);pn=pw*ph;baseSmall=resizeArea(base,pw,ph);targetSmall=resizeArea(target,pw,ph);positions=findMosaic(baseSmall,targetSmall);states=Array(pn);altStates=Array(pn);for(i=0;i<pn;i++)states[i]=0;piecePositions=Array(pn);screenImageData=ctx.createImageData(width,height);baseImageData=getImageData(base);updateAltImageData()}function updateAltImageData(){altImageData=getImageData(base)}
function drawMosaic(){var a=floor(width/pw),b=floor(height/ph),c=0,m=baseImageData.data,q=altImageData.data,o=screenImageData.data,f=4*(width-a),d,e,g,k,l,p,r;for(g=0;g<ph;g++)for(k=0;k<pw;k++){e=piecePositions[c];d=altStates[c]?q:m;l=k*a;p=g*b;r=e.x;e=e.y;l=4*(p*width+l);r=4*(e*width+r);for(e=0;e<b;e++){for(p=0;p<a;p++)o[r++]=d[l++],o[r++]=d[l++],o[r++]=d[l++],o[r++]=255,l++;l+=f;r+=f}c++}ctx.putImageData(screenImageData,0,0)}
function resizeArea(a,b,c){sw=a.width;sh=a.height;w=floor(sw/b);h=floor(sh/c);dstCanvas=createCanvas(b,c);srcImageData=getImageData(a);dstImageData=dstCanvas.getContext("2d").createImageData(b,c);srcData=srcImageData.data;dstData=dstImageData.data;i=0;n=w*h;var m,q,o,f,d;sum=Array(3);for(m=0;m<c;m++)for(a=0;a<b;a++){sum[0]=0;sum[1]=0;sum[2]=0;q=4*(m*h*sw+a*w);o=4*(sw-w);for(d=0;d<h;d++){for(f=0;f<w;f++)sum[0]+=srcData[q++],sum[1]+=srcData[q++],sum[2]+=srcData[q++],q++;q+=o}dstData[i]=sum[0]/n;dstData[i+
1]=sum[1]/n;dstData[i+2]=sum[2]/n;dstData[i+3]=255;i+=4}getContext(dstCanvas).putImageData(dstImageData,0,0);return dstCanvas}function getLightness(a,b){b*=4;return(a[b]+a[b+1]+a[b+2])/3}function flatten(a){flat=[];for(i=0;i<a.length;++i)for(j=0;j<a[i].length;++j)flat.push(a[i][j]);return flat}
function findMosaic(a,b){positions=Array(pn);srcData=getImageData(a).data;dstData=getImageData(b).data;binCount=256;srcBins=Array(binCount);dstBins=Array(binCount);for(i=0;i<binCount;++i)srcBins[i]=[],dstBins[i]=[];for(i=0;i<pn;++i)srcBins[getLightness(srcData,i)|0].push(i),dstBins[getLightness(dstData,i)|0].push(i);flatSrc=flatten(srcBins);flatDst=flatten(dstBins);for(i=0;i<pn;++i)positions[flatSrc[i]]=flatDst[i];return positions}
function trigger(a,b){var c=b*pw+a;0==states[c]&&(states[c]=millis())}function mouseMoved(){var a=mouseX/pieceSize,b=mouseY/pieceSize;if(0<=a&&0<=b&&a<pw&&b<ph)for(i=0;i<pw;i++)for(j=0;j<ph;j++)dist(i,j,a,b)<moveRadius*random(0.1,1)&&trigger(i,j);lastMouseMoved=millis()}function mousePressed(){backwards||("undefined"!=typeof beginRewind&&beginRewind(),backwards=!0,backwardsStart=millis())}
function updateMosaic(){var a=height,b=floor(width/pw),a=floor(a/ph),c=millis(),m=0,q,o,f,d,e,g,k,l,p,r=c-backwardsStart;c-lastMouseMoved>idleTime&&trigger(pick(pw),pick(ph));if(lastBackwards&&r>moveTime){backwards=!1;for(i=0;i<states.length;i++)states[i]=0;"undefined"!=typeof endRewind&&endRewind()}lastBackwards=backwards;for(o=0;o<ph;o++)for(q=0;q<pw;q++)f=positions[m],d=floor(f/pw),e=f-d*pw,g=q*b,f=o*a,e*=b,d*=a,k=backwards?constrain(backwardsStart-states[m],0,moveTime)-r:constrain(c-states[m],
0,moveTime),k=0==states[m]?0:constrain(k/moveTime,0,1),k=smoothStep(k),l=floor(abs(e-g)),p=floor(abs(d-f)),k*=l+p,l>p?(g=floor(0==l?e:lerp(g,e,constrain(k,0,l)/l)),f=floor(0==p?d:lerp(f,d,constrain(k-l,0,p)/p)),altStates[m]=k<l):(g=floor(0==l?e:lerp(g,e,constrain(k-p,0,l)/l)),f=floor(0==p?d:lerp(f,d,constrain(k,0,p)/p)),altStates[m]=k<p),piecePositions[m]={x:g,y:f},m++};var files="data/pdfglitch.png data/building.png data/bytebeat.png data/cmdtab.png data/gpunoise.png data/infinitefill.png data/interface.png data/stacks.png data/street.png".split(" "),images=loadImages(files),dataWidth,dataHeight,allOpaque=!0;function flipnib(a){return(a&15)<<4|(a&240)>>4}function flipopp(a){return(a&170)>>1|(a&85)<<1}
function decode(a){for(var b,c=0,m=4*dataWidth*dataHeight;c<m;)b=(c>>2)%256,a[c]=b^flipopp(b^flipnib(b^a[c++])),a[c]=b^flipopp(b^flipnib(b^a[c++])),a[c]=b^flipopp(b^flipnib(b^a[c++])),c++}var imagesData,regionMap,modeMap,blendMap;
function setupBaseGenerator(){dataWidth=images[0].width;dataHeight=images[0].height;imagesData=Array(images.length);for(i in images)imagesData[i]=imageToRaw(images[i]),-1!=files[i].indexOf("noise")&&decode(imagesData[i]);base=createCanvas(width,height);regionMap=createCanvas(width,height);modeMap=createCanvas(width,height);blendMap=createCanvas(width,height)}function generateBase(){passes=3;for(i=0;i<passes;i++)createSingle();saturate()}
function createSingle(){buildTriangleField(regionMap,images.length,random(8,1024));buildTriangleField(modeMap,255,random(8,64));buildTriangleField(blendMap,4,random(32,512));var a=getImageData(base),b=getImageData(regionMap),c=getImageData(modeMap),m=getImageData(blendMap),q=dataWidth*dataHeight,o=width*height,f=0,d=-1,e=0,g=1,k=floor(pow(2,random(1,6))),l=0.2>random(),p=a.data,b=b.data,c=c.data,m=m.data,r,t=0,u=0,v,s,C,D,z,A,B;for(r=0;r<o;r++,u+=4){f=b[u]%images.length;1==g?t++:l?0==r%g&&t++:0==
r%width%g&&t++;if(f!=d)if(e=c[u],g=0<(e&1)?k:1,0<(e&2)&&0<(e&4))t=0;else{if(0<(e&8)||0<(e&16))t=floor(floor(r/width)/g)*dataWidth;0<(e&32)&&(t+=r%width)}t%=q;s=imagesData[f][4*t];C=imagesData[f][4*t+1];D=imagesData[f][4*t+2];if(allOpaque)z=s,A=C,B=D;else switch(d=p[u],e=p[u+1],v=p[u+2],m[u]%4){case 0:z=s;A=C;B=D;break;case 1:z=255-((255-d)*(255-s)>>8);A=255-((255-e)*(255-C)>>8);B=255-((255-v)*(255-D)>>8);s=128;z=d+((z-d)*s>>8);A=e+((A-e)*s>>8);B=v+((B-v)*s>>8);break;case 2:z=d*s>>8;A=e*C>>8;B=v*D>>
8;s=128;z=d+((z-d)*s>>8);A=e+((A-e)*s>>8);B=v+((B-v)*s>>8);break;case 3:z=128>d?d*s>>7:255-((255-d)*(255-s)>>7),A=128>e?e*C>>7:255-((255-e)*(255-C)>>7),B=128>v?v*D>>7:255-((255-v)*(255-D)>>7),s=128,z=d+((z-d)*s>>8),A=e+((A-e)*s>>8),B=v+((B-v)*s>>8)}p[u]=z;p[u+1]=A;p[u+2]=B;p[u+3]=255;d=f}getContext(base).putImageData(a,0,0);allOpaque=!1}
function saturate(){buildTriangleField(blendMap,160,random(16,1024));var a=getImageData(base),b=getImageData(blendMap),c=a.data,b=b.data,m=width*height,q,o=0,f,d,e,g,k,l;for(q=0;q<m;q++,o+=4)if(f=c[o],d=c[o+1],e=c[o+2],k=g=f,d>g&&(g=d),e>g&&(g=e),d<k&&(k=d),e<k&&(k=e),k!=g){k=g-k;f==g?(d=(d-e)/k,0>d&&(d+=6)):d=d==g?2+(e-f)/k:4+(f-d)/k;f=d|0;mode=b[o];if(100>mode)switch(d-=f,l=mode/100,e=(1-l)*g,k=(1-l*d)*g,l=(1-l*(1-d))*g,f){case 0:f=g;d=l;break;case 1:f=k;d=g;break;case 2:f=e;d=g;e=l;break;case 3:f=
e;d=k;e=g;break;case 4:f=l;d=e;e=g;break;default:f=g,d=e,e=k}else if(150>mode)switch(f){case 0:f=g;e=d=255;break;case 1:f=255;d=g;e=255;break;case 2:f=255;d=g;e=255;break;case 3:d=f=255;e=g;break;case 4:d=f=255;e=g;break;default:f=g,e=d=255}else f=d=e=g;c[o]=f;c[o+1]=d;c[o+2]=e}getContext(base).putImageData(a,0,0)}
function buildTriangleField(a,b,c){a=getContext(a);ox=-random(c);for(y=py=oy=-random(c);py<height;){x=px=ox;for(y+=c;px<width;)px=x,x+=c,off=pick()?0:random(c/4),pick()?(fill(pick(b),a),triangle(px,py,px-off,y+off,x,py,a),fill(pick(b),a),triangle(x,py,x,y,px-off,y+off,a)):(fill(pick(b),a),triangle(px-off,py-off,px,y,x,y,a),fill(pick(b),a),triangle(x,py,x,y,px-off,py-off,a));py=y}};var translationLatin="datu;veril\u0259nl\u0259r;podatak;dada;datumo;datu;donn\u00e9e;podatak;dato;g\u00f6gn;dati;duomenys;adat;gegeven;dados;dat\u0103;podatek;podatak;datos;veri;d\u1eef li\u1ec7u".split(";"),translationOther="\u03b4\u03b5\u03b4\u03bf\u03bc\u03ad\u03bd\u03b1 \u0434\u0430\u043d\u044b\u044f \u0434\u0430\u043d\u043d\u0438 \u6570\u636e \ub370\uc774\ud130 \u0628\u064a\u0627\u0646\u0627\u062a \u0989\u09aa\u09be\u09a4\u09cd\u09a4 \u062f\u0627\u062f\u0647 \u0434\u0435\u0440\u0435\u043a \u05e0\u05ea\u05d5\u05e0\u05d9\u05dd \u0431\u0435\u0440\u0438\u043b\u0438\u0448\u0442\u0435\u0440 \u043f\u043e\u0434\u0430\u0442\u043e\u043a \u0935\u093f\u0926\u093e \u30c7\u30fc\u30bf \u044b\u04a5\u043f\u0430\u043b\u0435 \u0434\u0430\u0442\u0430 \u0434\u0430\u043d\u043d\u044b\u0435 \u0627\u0639\u062f\u0627\u062f \u062f\u0631\u0627\u0648\u06d5 \u043f\u043e\u0434\u0430\u0442\u0430\u043a \u0ba4\u0bb0\u0bb5\u0bc1 \u0e02\u0e49\u0e2d\u0e21\u0e39\u0e25 \u0434\u0430\u043d\u0456 \u0645\u0639\u0637\u06cc\u0627\u062a \u6570\u636e \u05d3\u05d0\u05d8\u05df".split(" "),
baseTranslation="data";function randomTranslation(){var a=random(5);return 3>a?translationOther[pick(translationOther.length)]:4>a?translationLatin[pick(translationLatin.length)]:baseTranslation}function setupText(a){"undefined"===typeof a&&(a=this.ctx);a.font="100px sans-serif";a.textAlign="center";a.textBaseline="middle"}
function drawCenteredText(a,b,c){"undefined"===typeof c&&(c=this.ctx);var m=c.measureText(a),b=b/m.width;c.save();c.translate(width/2,height/2);c.scale(b,b);c.fillText(a,0,0);c.restore()};function setup(){setupBaseGenerator();generateBase();generateTarget();setupMosaic()}function draw(){updateMosaic();drawMosaic()}function generateTarget(){target=createCanvas(width,height);targetCtx=getContext(target);setupText(targetCtx);background(255,targetCtx);drawCenteredText(randomTranslation(),750,targetCtx)}function beginRewind(){generateBase();updateAltImageData()}function endRewind(){generateTarget();setupMosaic()}function fullscreenChange(){};
